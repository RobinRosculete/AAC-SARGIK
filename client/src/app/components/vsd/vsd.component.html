<ion-modal
  #modal
  (willDismiss)="onWillDismiss($event)"
  (ionModalDidPresent)="startCamera()"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="cancel()">Cancel</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="confirmCropping()" *ngIf="myImage"
            >Confirm</ion-button
          >
        </ion-buttons>

        <ion-title>Visual Scene Display</ion-title>
      </ion-toolbar>
    </ion-header>
    <div class="camera-container" *ngIf="!photoCaptured">
      <div id="cameraPreview" class="cameraPreview"></div>
      <div class="camera-controls">
        <ion-button
          class="button_color"
          (click)="captureImage()"
          expand="block"
          id="capture"
        >
          <ion-icon name="camera-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button
          class="button_color"
          (click)="selectImageFromGallery()"
          expand="block"
          id="gallery"
        >
          <ion-icon name="images-outline"></ion-icon>
        </ion-button>
        <ion-button
          class="button_color"
          (click)="flipCamera()"
          expand="block"
          id="flip"
        >
          <ion-icon name="camera-reverse-outline"></ion-icon>
        </ion-button>
      </div>
    </div>

    <div *ngIf="photoCaptured && !myImage">
      <ion-img *ngIf="croppedImage" [src]="croppedImage"></ion-img>
      <ion-img *ngIf="!croppedImage" [src]="image"></ion-img>
      <ion-button
        class="button_color"
        (click)="retakePhoto()"
        expand="block"
        id="capture"
      >
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
      <ion-button
        class="button_color"
        (click)="editPhoto()"
        expand="block"
        id="gallery"
      >
        <ion-icon name="create-outline"></ion-icon>
      </ion-button>
    </div>

    <input
      type="file"
      #fileInput
      style="display: none"
      (change)="onFileSelected($event)"
    />

    <image-cropper
      #cropper
      *ngIf="myImage"
      [imageBase64]="myImage"
      format="png"
      [maintainAspectRatio]="true"
      [aspectRatio]="1 / 1"
      (imageCropped)="imageCropped($event)"
    ></image-cropper>

    <ion-img [src]="croppedImage ? croppedImage : image"></ion-img>

    <div *ngIf="photoCaptured && !myImage">
      <ion-img [src]="croppedImage ? croppedImage : image"></ion-img>
      <ion-button
        class="button_color"
        (click)="retakePhoto()"
        expand="block"
        id="retake"
      >
        <ion-icon name="refresh-outline"></ion-icon>
        Retake
      </ion-button>
      <ion-button
        class="button_color"
        (click)="generateCaption()"
        expand="block"
        id="flip"
      >
        Generate Caption
      </ion-button>

      <ion-button
        class="button_color"
        (click)="editPhoto()"
        expand="block"
        id="edit"
      >
        <ion-icon name="create-outline"></ion-icon>
        Edit
      </ion-button>
    </div>

    <div *ngIf="captionSectionVisible">
      <div *ngIf="captionSectionVisible" class="caption-box">
        <ion-item *ngIf="captionSectionVisible">
          <ion-label position="floating">Caption</ion-label>
          <ion-textarea
            [(ngModel)]="captionText"
            placeholder="Enter caption here..."
          ></ion-textarea>
        </ion-item>
      </div>
      <div *ngIf="photoCaptured && !myImage">
        <ion-button
          id="gallery"
          class="button_color"
          (click)="retakePhoto()"
          expand="block"
        >
          <ion-icon name="refresh-outline"></ion-icon>
          Retake
        </ion-button>

        <ion-button
          class="button_color"
          (click)="startSpeechToText()"
          expand="block"
          id="capture"
        >
          <ion-icon name="mic-outline"></ion-icon>
          Voice to Text
        </ion-button>

        <ion-button
          class="button_color"
          (click)="confirmCaption()"
          expand="block"
          id="flip"
        >
          <ion-icon name="checkmark-outline"></ion-icon>
          Confirm
        </ion-button>
      </div>
    </div>
  </ng-template>
</ion-modal>
